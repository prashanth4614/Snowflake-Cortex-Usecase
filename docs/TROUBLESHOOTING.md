# Cortex Agent Multi-Tool Troubleshooting Guide

## Issue Identified

Based on your debug output, the problem has been identified:

### What's Happening:
1. ‚úÖ **Faq Search (cortex_search) IS being called** - Working correctly
2. ‚ùå **Sales Analyst (cortex_analyst_text_to_sql) is NOT being called** - This is the problem
3. ‚ùå **Claude is refusing to call the second tool** - Instead, it's saying "I cannot provide this information"

### Root Cause:
The LLM (Claude 3.5 Sonnet) is not following the instruction to call BOTH tools when presented with a compound query. This is a **prompt engineering challenge** with how Claude interprets multi-tool orchestration.

## Solutions Implemented

### 1. Fixed Tool Name Extraction
**Before:** Tool names showed as "Unknown"
**After:** Correctly extracts and maps:
- `cortex_search` ‚Üí "Faq Search"
- `cortex_analyst_text_to_sql` ‚Üí "Sales Analyst"

```python
tool_name_map = {
    'cortex_search': 'Faq Search',
    'cortex_analyst_text_to_sql': 'Sales Analyst'
}
```

### 2. Enhanced Response Instruction
**Key Changes:**
- Added explicit tool type names (cortex_search, cortex_analyst_text_to_sql)
- Stronger directive language ("YOU MUST", "NO EXCEPTIONS")
- More detailed examples showing CORRECT vs WRONG actions
- Explicit warning against saying "I cannot provide" without calling tools
- Step-by-step parsing instructions

**Critical Addition:**
```
NEVER say "I cannot provide this information" if you haven't called the appropriate tool
DO NOT attempt to answer ANY data question without first calling 'Sales Analyst'
```

### 3. Added Tool Validation
New validation warnings that alert when expected tools aren't called:
- ‚ö†Ô∏è Warning if only one tool is called when both are needed
- ‚úÖ Success message when both tools are called
- ‚ÑπÔ∏è Info message for single-tool queries

## Testing Instructions

### Test Query:
```
"What is the refund policy and how many orders were placed?"
```

### Expected Behavior:
1. üîß Calling tool: Faq Search (type: cortex_search)
2. üîß Calling tool: Sales Analyst (type: cortex_analyst_text_to_sql)
3. ‚úÖ SQL query generated by Sales Analyst
4. üìä Tools used in this response: Faq Search, Sales Analyst
5. ‚úÖ Both tools were called successfully!

### What You Should See:
- **Policy information** from the Faq Search with citations
- **Order count** from the Sales Analyst with SQL query displayed
- **Both sections** combined in a single response

## If It Still Doesn't Work

### Option 1: Try Different Query Phrasing
Sometimes rephrasing helps trigger both tools:
```
"I need two things: First, what is the refund policy? Second, how many orders were placed?"
```

Or more explicitly:
```
"Use Faq Search to find the refund policy, then use Sales Analyst to count the orders."
```

### Option 2: Model Limitations
Claude sometimes struggles with multi-tool orchestration despite clear instructions. This is a known limitation with LLM-based agents. Possible workarounds:

1. **Sequential Queries**: Ask questions separately
   - First: "What is the refund policy?"
   - Second: "How many orders were placed?"

2. **Model Parameter Tuning**: Try adjusting the model temperature or using a different model version

3. **Explicit Tool Forcing**: Modify the API call to require specific tools (if Snowflake API supports this)

### Option 3: Check Snowflake API Logs
The issue might be at the API level. Check if:
- Both tools are properly registered in the Snowflake environment
- The Sales Analyst semantic model file is accessible
- There are any permission issues with the cortex_analyst_text_to_sql tool

## Understanding the Debug Output

### Good Output (Both Tools):
```
üîß Calling tool: Faq Search (type: cortex_search)
Debug - Tool use content: {...}
üîß Calling tool: Sales Analyst (type: cortex_analyst_text_to_sql)
Debug - Tool use content: {...}
‚úÖ SQL query generated by Sales Analyst
üìä Tools used in this response: Faq Search, Sales Analyst
‚úÖ Both tools were called successfully!
```

### Current Output (Only One Tool):
```
üîß Calling tool: Faq Search (type: cortex_search)
Debug - Tool use content: {...}
üìä Tools used in this response: Faq Search
‚ö†Ô∏è Warning: Only Faq Search was called. If the query included data questions, Sales Analyst should have been called too.
```

## Known Limitations

### LLM Behavior Variability
Even with perfect prompt engineering, Claude's behavior can vary:
- **Non-deterministic**: Same query might get different tool calls on different runs
- **Context-dependent**: Previous messages in the conversation can affect behavior
- **Instruction Following**: Claude sometimes prioritizes being "helpful" over strict instruction following

### Snowflake Cortex Agent Constraints
- The agent runs on Snowflake's infrastructure with their specific Claude configuration
- You cannot directly control parameters like temperature or top_p
- Tool orchestration depends on how Snowflake has implemented the agent API

## Verification Checklist

- [ ] Debug mode is enabled
- [ ] Tool names now show correctly (not "Unknown")
- [ ] Faq Search is being called for policy questions
- [ ] Warning appears when Sales Analyst should be called but isn't
- [ ] Response instruction includes explicit tool type names
- [ ] Query clearly asks for both policy AND data information

## Next Steps

1. **Test with the updated code** - Try the same query again
2. **Monitor the debug output** - Look for both tool_use events
3. **Check validation warnings** - See if the warning appears
4. **Try alternate phrasing** - Experiment with different question formats
5. **Review Snowflake logs** - Check for any API-level issues

## Success Criteria

The issue is resolved when:
1. ‚úÖ Both tools are called for compound queries
2. ‚úÖ Tool names are correctly identified
3. ‚úÖ SQL is generated and executed
4. ‚úÖ Results from both tools appear in the final response

## Contact Points

If issues persist:
- Review Snowflake Cortex Agent documentation
- Check Snowflake community forums
- Verify semantic model configuration
- Contact Snowflake support for API-specific issues
